# Documentation.

## Config file.
Keeps most of the VM specific settings, as well as system information generated by 'configuration' script.

## Passing through USB devices (HID), especially gamepads/joysticks.
If you want to pass USB devices, keyboard, mouse and joystick should be picked up and generated by script. Use 'lsusb' command in terminal and choose device you want to use, for example:
```
Bus 008 Device 003: ID 1345:1000 Sino Lite Technology Corp. Generic   USB  Joystick
```
Here, important part is 1345:1000, first number (1345) represents vendorid, and second (1000) productid.
Now, change config file for your particular device (if not present already), so it will follow this pattern (pick any usb device, usb1, usb2, usb3, usb4 or add new one):
```
usb1_vendorid=0x1345
usb1_productid=0x1000
```
Now you need to add device to the VM script, first we need to add "qemu-xhci" USB device, and then any of our devices, for example:
```
-device qemu-xhci,id=xhci,p2=4 \
-device usb-host,bus=xhci.0,vendorid=$usb1_vendorid,productid=$usb1_productid,port=1 \
-device usb-host,bus=xhci.0,vendorid=$usb2_vendorid,productid=$usb2_productid,port=2 \
```
For device 'qemu-xhci', 'p2=4' represents type of the USB port and number of ports, 'p2' represents USB2, if you need USB3, you have to use 'p3' option instead, or combine the two (p3=8, for 8 USB3 ports). Device 'qemu-xhci' supports up to 16 ports.
Where '-device usb-host,bus=xhci.0,...' represents USB device you want to pass to the guest, 'port=1' (2,3,4) represents port USB device is attached to, you can add or subtract how much devices you need (up to 16 per 'qemu-xhci' controller).

## AMD drivers BSOD/CRASH on Windows 10 guest.
In this case, you need to use 'AMD (workaround for Windows driver bug)' option in 'GPU Passthrough choice' durring VM creation process. Or, add it manually by replacing:
```
-device pcie-root-port,bus=pcie.0,multifunction=on,port=1,chassis=1,id=port.1 \
-device vfio-pci,host=$IOMMU_GPU,bus=port.1,multifunction=on \
-device vfio-pci,host=$IOMMU_GPU_AUDIO,bus=port.1 \

```
with:
```
-device ioh3420,bus=pcie.0,addr=1c.0,multifunction=on,port=1,chassis=1,id=root.1 \
-device vfio-pci,host=$IOMMU_GPU,bus=root.1,addr=00.0,multifunction=on,x-vga=on \
-device vfio-pci,host=$IOMMU_GPU_AUDIO,bus=root.1,addr=00.1 \
```

## Removing Audio passthrough.
By default, this script passes audio device to the VM, this may cause some issues if particular device is not possible to pass, most of the common integrated audio devices (Realtek corp. etc.) should not have an issue with this option, however, if you face issues with it, replace:
```
-device vfio-pci,host=$IOMMU_PCI_AUDIO \
```
with:
```
-soundhw all \
```
This should make VM work, but expect increased latency and everything, since audio device is emulated by QEMU now.

## vBIOS
You may need to pass VIDEO BIOS of the GPU to the VM, in that scenario, create VM with 'GPU VBIOS append' option. But you are not done here, you need to extract vBIOS from the GPU, or download it from TechPowerUp website. After you got the rom file, simply put it where you want, and point to it in the config file, change:
```
VBIOS=/root/VBIOS.rom
```
to:
```
VBIOS=/yourpath/yourrom.rom
```
Additionally, if you did not create your VM with 'GPU VBIOS append' option. Replace the following line in VM script:
```
-device vfio-pci,host=$IOMMU_GPU,bus=port.1,multifunction=on \
```
with:
```
-device vfio-pci,host=$IOMMU_GPU,bus=port.1,multifunction=on,romfile=$VBIOS \
```
How to get proper vBIOS for your GPU:
https://gitlab.com/YuriAlek/vfio/-/wikis/vbios

## VirGL issues, flickering, graphical corruption etc.
In case you face flicker or graphical corruption using VirGL, you can try to downgrade virglrenderer package to 0.7.0 version. Afterwards, depending on the distribution you use, you may need to symlink it for QEMU to recognize since .so library name has been changed, on Arch Linux, this command should do the job:
```
ln -sf /usr/lib/libvirglrenderer.so.0 /usr/lib/libvirglrenderer.so.1
```
It may differ for your distribution, so you may need to look it up manually.

## Windows 9x VBE drivers for proper color depth and resolution
Install drivers from in your Windows 9x guest VM:
https://bearwindows.zcm.com.au/vbe9x.htm
From device manager, VGA adapter, update driver from 032mb location (or higher = not tested), reboot and set resolution and color depth.

## Windows XP drivers
Use QXL VGA adapter and download virtio Windows drivers in VM creation. From device manager in Windows guest, install from mounted virtio-win.iso, qxl/xp/x86 location. Reboot and you should have accelerated 2D.
